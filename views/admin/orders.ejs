<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard | Orders</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/AdminDashboard.css">
</head>
<body>

<div class="sidebar" id="sidebar">
  <div class="d-flex justify-content-center mb-5 mt-3">
  <img src="<%= settings.logo ? settings.logo : '/images/napslogo.png' %>" alt="Logo" width="150" />
  </div>
  <nav>
    <a href="/admin/index"><i class="bi bi-speedometer2"></i> Dashboard</a>
    <a href="/admin/users" ><i class="bi bi-person-circle"></i> Users Profile</a>
    <a href="/admin/staff"><i class="bi bi-people-fill"></i> Account Creation</a>
    
<div class="dropdown custom-dropdown" style="position: relative; width: 100%; margin-left: 25px;">
  <a href="#" class="dropdown-toggle d-block py-2 text-dark text-decoration-none rounded mb-2" id="ordersDropdown" style="background: linear-gradient(90deg, #03C4E7, #0047FF);
    color: #fff;">
    <i class="bi bi-receipt"></i> Orders
  </a>
  <ul class="dropdown-menu" aria-labelledby="ordersDropdown">
     <li>
      <a class="dropdown-item" class="okay" href="/admin/orders" >
        <i class="bi bi-check-circle me-2"></i> Completed
      </a>
    </li>
    <li>
      <a class="dropdown-item" href="/admin/order_pending">
        <i class="bi bi-hourglass-split me-2"></i> Pending
      </a>
    </li>
    <li>
      <a class="dropdown-item" href="/admin/order_rejected">
        <i class="bi bi-x-circle me-2"></i> Rejected
      </a>
    </li>
  </ul>
</div>




    <a href="/admin/reservations"><i class="bi bi-journal-bookmark"></i> Reservations</a>
    <a href="/admin/discounts"><i class="bi bi-percent"></i> Discounts</a>
    <a href="/admin/reviews"><i class="bi bi-chat-dots"></i> Users Reviews</a>
    <a href="/admin/products"><i class="bi bi-box-seam"></i> Inventory</a>
    <a href="/admin/table"><i class="bi bi-table"></i> Table</a>
    <a href="/admin/settings" ><i class="bi bi-gear"></i> Settings</a>
  </nav>
</div>
<div class="main-content">
  <div class="navbar-custom-wrapper">
    <nav class="navbar navbar-custom d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <img src="/images/admin-avatar.avif" alt="Admin" class="rounded-circle me-3">
        <div class="admin-info">
          <div class="fw-semibold">Super Admin</div>
          <p>napsgrillrestobar08@gmail.com</p>
        </div>
      </div>
      <a href="/logout" class="btn btn-sm btn-danger d-flex align-items-center">
        <i class="bi bi-box-arrow-right"></i>
      </a>
    </nav>
  </div>

  <div class="container mt-5">
    <h2 class="mb-4 text-center fw-bold">All Orders</h2>

    <% if (allOrders.length === 0) { %>
      <p>No orders to display.</p>
    <% } else { %>
      <div class="table-responsive">
        <div class="row mb-3">
          <div class="col-md-4">
            <input type="text" id="orderSearch" class="form-control" placeholder="Search by name, email, or ID">
          </div>
          <div class="col-md-4" style="display: none;">
  <select id="orderStatusFilter" class="form-select">
    <option value="">All Statuses</option>
    <option value="pending">Pending</option>
    <option value="processing">Processing</option>
    <option value="ready_to_pickup">Ready to Pickup</option>
    <option value="completed">Completed</option>
    <option value="rejected">Rejected</option>
    <option value="cancelled">Cancelled</option>
  </select>
</div>

        </div>

        <table class="table table-bordered table-hover align-middle text-center">
          <thead class="table-dark">
            <tr>
              <th>Order ID</th>
              <th>Customer Name</th>
              <th>Customer Email</th>
              <th>Total (₱)</th>
              <th>Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% allOrders.forEach(order => { %>
              <tr data-name="<%= order.userId?.firstName + ' ' + order.userId?.lastName %>" 
                  data-email="<%= order.userId?.email || 'N/A' %>" 
                  data-id="<%= order._id %>" 
                  data-status="<%= order.status %>">
                <td><%= order._id %></td>
                <td><%= order.userId?.firstName && order.userId?.lastName ? `${order.userId.firstName} ${order.userId.lastName}` : order.fullName %></td>
                <td><%= order.userId?.email || 'N/A' %></td>
                <td>₱<%= order.netTotal.toFixed(2) %></td>
                <td><%= new Date(order.createdAt).toLocaleString('en-PH', { timeZone: 'Asia/Manila' }) %></td>
                <td>
                  <% if (order.status === 'completed') { %>
                    <span class="badge bg-success">Completed</span>
                  <% } else if (order.status === 'rejected') { %>
                    <span class="badge bg-danger">Rejected</span>
                  <% } else if (order.status === 'cancelled') { %>
                    <span class="badge bg-secondary">Cancelled</span>
                  <% } else if (order.status === 'pending') { %>
                    <span class="badge bg-warning text-dark">Pending</span>
                  <% } else if (order.status === 'processing') { %>
                    <span class="badge bg-info text-dark">Processing</span>
                  <% } else if (order.status === 'ready_to_pickup') { %>
                    <span class="badge bg-primary">Ready to Pickup</span>
                  <% } %>
                </td>
                <td>
                  <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#viewItemsModal<%= order._id %>">View Items</button>
                </td>
              </tr>

              <div class="modal fade" id="viewItemsModal<%= order._id %>" tabindex="-1" aria-labelledby="modalLabel<%= order._id %>" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                  <div class="modal-content">
                    <div class="modal-header bg-dark text-white">
                      <h5 class="modal-title" id="modalLabel<%= order._id %>">
                        Order Items — <%= order.userId?.firstName %> <%= order.userId?.lastName %>
                      </h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <h6 class="mb-3">Ordered Items:</h6>
                      <ul class="list-group">
                        <% order.items.forEach(item => { %>
                          <li class="list-group-item d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center gap-3">
                              <img src="/uploads/<%= item.productId?.image || 'default.png' %>" alt="item-image" width="60" height="60" class="rounded">
                              <div>
                                <strong><%= item.name %></strong><br>
                                <small>Qty: <%= item.quantity %></small>
                              </div>
                            </div>
                            <div>₱<%= item.price.toFixed(2) %></div>
                          </li>
                        <% }) %>
                      </ul>

                      <% if (order.discounts && order.discounts.length > 0) { %>
                        <div class="mt-4">
                          <h6>Discounts Applied:</h6>
                          <ul class="list-group">
                            <% order.discounts.forEach(discount => { %>
                              <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>
                                  <%= discount.type === 'voucher' ? 'Voucher Discount' : 'PWD Discount' %>
                                </span>
                                <span>-₱<%= discount.amount.toFixed(2) %></span>
                              </li>
                            <% }) %>
                          </ul>
                        </div>
                      <% } %>

                      <div class="mt-4">
                        <strong>Net Total:</strong> ₱<%= order.netTotal.toFixed(2) %>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                  </div>
                </div>
              </div>
            <% }) %>
          </tbody>
        </table>
          <div class="d-flex justify-content-center">
  <nav>
    <ul class="pagination" id="orderPagination"></ul>
  </nav>
</div>

      </div>
      
    <% } %>
    <nav>

</nav>
  </div>
  
</div>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".dropdown-toggle").forEach(toggle => {
      toggle.addEventListener("click", function (e) {
        e.preventDefault();

        const parentDropdown = this.closest(".dropdown");

        // Close others
        document.querySelectorAll(".dropdown").forEach(d => {
          if (d !== parentDropdown) d.classList.remove("show");
        });

        parentDropdown.classList.toggle("show");
      });
    });

    document.addEventListener("click", function (e) {
      if (!e.target.closest(".dropdown")) {
        document.querySelectorAll(".dropdown").forEach(d => d.classList.remove("show"));
      }
    });
  });
   const searchInput = document.getElementById("orderSearch");
  const statusFilter = document.getElementById("orderStatusFilter");
  const orderRows = Array.from(document.querySelectorAll("tbody tr"));
  const pagination = document.getElementById("orderPagination");
  const rowsPerPage = 10;
  let currentPage = 1;

  function filterOrders() {
    const query = searchInput.value.toLowerCase();
    const status = statusFilter.value;

    return orderRows.filter(row => {
      const name = row.dataset.name?.toLowerCase() || '';
      const email = row.dataset.email?.toLowerCase() || '';
      const id = row.dataset.id?.toLowerCase() || '';
      const rowStatus = row.dataset.status;

      return (
        (name.includes(query) || email.includes(query) || id.includes(query)) &&
        (status === "" || rowStatus === status)
      );
    });
  }

  function renderTable() {
    const filtered = filterOrders();
    const totalPages = Math.ceil(filtered.length / rowsPerPage);
    currentPage = Math.min(currentPage, totalPages || 1);

    orderRows.forEach(row => row.style.display = "none");

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    filtered.slice(start, end).forEach(row => {
      row.style.display = "";
    });

    renderPagination(totalPages);
  }

  function renderPagination(totalPages) {
  pagination.innerHTML = "";

  const createPageItem = (page, label = page, active = false, disabled = false) => {
    const li = document.createElement("li");
    li.className = `page-item ${active ? "active" : ""} ${disabled ? "disabled" : ""}`;
    li.innerHTML = `<a class="page-link" href="#">${label}</a>`;
    if (!disabled) {
      li.onclick = e => {
        e.preventDefault();
        currentPage = page;
        renderTable();
      };
    }
    return li;
  };

  if (totalPages > 1) {
    if (currentPage > 1) pagination.appendChild(createPageItem(currentPage - 1, "«"));

    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
        pagination.appendChild(createPageItem(i, i, i === currentPage));
      } else if (
        (i === 2 && currentPage > 3) ||
        (i === totalPages - 1 && currentPage < totalPages - 2)
      ) {
        pagination.appendChild(createPageItem(null, "...", false, true));
      }
    }

    if (currentPage < totalPages) pagination.appendChild(createPageItem(currentPage + 1, "»"));
  }
}


  searchInput.addEventListener("input", () => {
    currentPage = 1;
    renderTable();
  });

  statusFilter.addEventListener("change", () => {
    currentPage = 1;
    renderTable();
  });

  // Initial render
  renderTable();
</script>
</body>
</html>
