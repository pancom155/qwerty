<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard | Orders</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/AdminDashboard.css">
</head>
<style>
  /* ===== Table Styling ===== */
.table {
  border-collapse: separate;
  border-spacing: 0;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
  overflow: hidden;
  margin-bottom: 1.5rem;
}

.table thead th {
  background-color: #f8f9fa;
  color: #495057;
  font-weight: 600;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border: none;
  padding: 1rem 0.75rem;
  vertical-align: middle;
}

/* Table Body */
.table tbody tr {
  transition: all 0.2s ease-in-out;
}

.table tbody td {
  padding: 14px 16px;
  vertical-align: middle;
  border: none !important;
  border-bottom: 1px solid #eee !important;
  font-size: 15px;
  color: #333;
}

/* Row Hover */
.table tbody tr:hover {
  background-color: #f7faff;
}

/* Center alignment */
.table td, 
.table th {
  text-align: center;
}

/* ===== Status Badges ===== */
.badge {
  padding: 0.35rem 0.75rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.badge.bg-success {
  background-color: #d4edda !important;
  color: #155724 !important;
}

.badge.bg-danger {
  background-color: #f8d7da !important;
  color: #721c24 !important;
}

.badge.bg-secondary {
  background-color: #e2e3e5 !important;
  color: #383d41 !important;
}

.badge.bg-warning {
  background-color: #fff3cd !important;
  color: #856404 !important;
}

.badge.bg-primary {
  background-color: #cce7ff !important;
  color: #004085 !important;
}

.badge.bg-info {
  background-color: #d1ecf1 !important;
  color: #0c5460 !important;
}


/* ===== Buttons in Table ===== */
.table .btn-sm {
  font-size: 13px;
  padding: 6px 14px;
  border-radius: 6px;
  transition: 0.2s;
  background-color: #17a2b8;
}

.table .btn-sm:hover {
  background-color: #0f8698;
  color: #fff;
  transform: scale(1.05);
}

/* ===== PAGINATION ===== */
.pagination-container {
  display: flex;
  justify-content: center;
  margin-top: 1.5rem;
}

.page-link {
  border: none;
  color: #495057;
  padding: 0.5rem 0.75rem;
  border-radius: 6px;
  margin: 0 2px;
}

.page-item.active .page-link {
  background-color: #17a2b8;
  border-color: #17a2b8;
}

.page-link:hover {
  background-color: #e9ecef;
  color: #495057;
}
/* ===== Filter Section ===== */
#orderSearch, #dateFrom, #dateTo, #clearFilters {
  border-radius: 8px;
  font-size: 14px;
}

#clearFilters {
  transition: 0.2s;
}

#clearFilters:hover {
  background: #0047FF;
  color: #fff;
  border-color: #0047FF;
}
.table-responsive::-webkit-scrollbar {
  height: 0px; 
}

.table-responsive {
  overflow-x: auto;
  scrollbar-width: none; /* hides scrollbar in Firefox */
}

.table-responsive::-webkit-scrollbar-track {
  background: transparent;
}

.table-responsive::-webkit-scrollbar-thumb {
  background: transparent;
}

/* Optional: prevent table from overflowing weirdly */
.table-responsive {
  border-radius: 10px;
}
/* ===== ORDER ID STYLING ===== */
.order-id {
  font-family: 'Courier New', monospace;
  font-size: 0.9rem;
  color: #000000;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
}

/* ===== AMOUNT STYLING ===== */
.amount {
  font-weight: 600;
  color: #28a745;
  font-size: 0.95rem;
}

/* ===== DATE STYLING ===== */
.date-display {
  font-size: 0.85rem;
  color: #495057;
}

.date-time {
  font-size: 0.75rem;
  color: #6c757d;
}
</style>
<body>

<div class="sidebar" id="sidebar">
  <div class="d-flex justify-content-center mb-5 mt-3">
  <img src="<%= settings.logo ? settings.logo : '/images/napslogo.png' %>" alt="Logo" width="150" />
  </div>
  <nav>
    <a href="/admin/index"><i class="bi bi-speedometer2"></i> Dashboard</a>
    <a href="/admin/users" ><i class="bi bi-person-circle"></i> Users Profile</a>
    <a href="/admin/staff"><i class="bi bi-people-fill"></i> Account Creation</a>
    
<div class="dropdown custom-dropdown" style="position: relative; width: 100%; margin-left: 25px;">
  <a href="#" 
     class="dropdown-toggle d-block py-2 text-decoration-none rounded mb-2" 
     id="ordersDropdown" 
     style="background: #5e5e5e; color: #fff;">
    <i class="bi bi-receipt"></i> Orders
  </a>
  <ul class="dropdown-menu" aria-labelledby="ordersDropdown">
     <li>
      <a class="dropdown-item" class="okay" href="/admin/orders" >
        <i class="bi bi-check-circle me-2"></i> Completed
      </a>
    </li>
    <li>
      <a class="dropdown-item" href="/admin/order_pending">
        <i class="bi bi-hourglass-split me-2"></i> Pending
      </a>
    </li>
    <li>
      <a class="dropdown-item" href="/admin/order_rejected">
        <i class="bi bi-x-circle me-2"></i> Rejected
      </a>
    </li>
  </ul>
</div>

    <a href="/admin/reservations"><i class="bi bi-journal-bookmark"></i> Reservations</a>
    <a href="/admin/discounts"><i class="bi bi-percent"></i> Discounts</a>
    <a href="/admin/reviews"><i class="bi bi-chat-dots"></i> Users Reviews</a>
    <a href="/admin/products"><i class="bi bi-box-seam"></i> Inventory</a>
    <a href="/admin/table"><i class="bi bi-table"></i> Table</a>
    <a href="/admin/calendar"><i class="bi bi-calendar-event"></i> Calendar</a>
    <a href="/admin/settings" ><i class="bi bi-gear"></i> Settings</a>
  </nav>

</div>

<div class="main-content">
  <div class="navbar-custom-wrapper">
    <nav class="navbar navbar-custom d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <img src="/images/admin-avatar.avif" alt="Admin" class="rounded-circle me-3">
        <div class="admin-info">
          <div class="fw-semibold">Super Admin</div>
          <p>napsgrillrestobar08@gmail.com</p>
        </div>
      </div>
      <a href="/logout" class="btn btn-sm btn-danger d-flex align-items-center">
        <i class="bi bi-box-arrow-right me-1"></i> Logout
      </a>
    </nav>
  </div>

  <div class="container mt-5">
    <h2 class="fw-bold mb-0" style="color: #333446;">All Orders</h2>

    <% if (allOrders.length === 0) { %>
      <p>No orders to display.</p>
    <% } else { %>
      <div class="table-responsive">
  <div class="row mb-3 align-items-end g-3">
    <!-- Search -->
    <div class="col-md-4">
      <input type="text" id="orderSearch" class="form-control" placeholder="Search by name, email, or ID">
    </div>

    <!-- Date From -->
    <div class="col-md-2">
      <label for="dateFrom" class="form-label fw-semibold">From</label>
      <input type="date" id="dateFrom" class="form-control">
    </div>

    <!-- Date To -->
    <div class="col-md-2">
      <label for="dateTo" class="form-label fw-semibold">To</label>
      <input type="date" id="dateTo" class="form-control">
    </div>

    <!-- Reset Button -->
    <div class="col-md-2">
      <button id="clearFilters" class="btn btn-outline-secondary w-100">
        <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
      </button>
    </div>

    <!-- Status Filter (still hidden) -->
    <div class="col-md-4" style="display: none;">
      <select id="orderStatusFilter" class="form-select">
        <option value="">All Statuses</option>
        <option value="pending">Pending</option>
        <option value="processing">Processing</option>
        <option value="ready">Ready to Pickup</option>
        <option value="completed">Completed</option>
        <option value="rejected">Rejected</option>
        <option value="cancelled">Cancelled</option>
      </select>
    </div>
  </div>
</div>


       <table class="table table-bordered table-hover align-middle text-center">
  <thead class="table-dark">
    <tr>
      <th>#</th>
      <th>Customer Name</th>
      <th>Customer Email</th>
      <th>Total (₱)</th>
      <th>Date</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <% allOrders.forEach((order, index) => { %>
      <tr data-name="<%= order.userId?.firstName + ' ' + order.userId?.lastName %>" 
          data-email="<%= order.userId?.email || 'N/A' %>" 
          data-id="<%= order._id %>" 
          data-status="<%= order.status %>">
        <!-- Auto-incremented row number -->
        <td><%= index + 1 %></td>
        
        <td><%= order.userId?.firstName && order.userId?.lastName ? `${order.userId.firstName} ${order.userId.lastName}` : order.fullName %></td>
        <td><%= order.userId?.email || 'N/A' %></td>
        <td>₱<%= order.netTotal.toFixed(2) %></td>
        <td><%= new Date(order.createdAt).toLocaleString('en-PH', { timeZone: 'Asia/Manila' }) %></td>
        <td>
          <% if (order.status === 'completed') { %>
            <span class="badge bg-success">Completed</span>
          <% } else if (order.status === 'rejected') { %>
            <span class="badge bg-danger">Rejected</span>
          <% } else if (order.status === 'cancelled') { %>
            <span class="badge bg-secondary">Cancelled</span>
          <% } else if (order.status === 'pending') { %>
            <span class="badge bg-warning text-dark">Pending</span>
          <% } else if (order.status === 'processing') { %>
            <span class="badge bg-info text-dark">Processing</span>
          <% } else if (order.status === 'ready') { %>
            <span class="badge bg-primary">Ready to Pickup</span>
          <% } %>
        </td>
        <td>
          <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#viewItemsModal<%= order._id %>">View Items</button>
        </td>
      </tr>

      <!-- Order Items Modal -->
      <div class="modal fade" id="viewItemsModal<%= order._id %>" tabindex="-1" aria-labelledby="modalLabel<%= order._id %>" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header text-black" style="background: rgb(218, 218, 218); border-radius: 12px 12px 0 0;">
              <h5 class="modal-title" id="modalLabel<%= order._id %>">
                <i class="bi bi-receipt me-2"></i>
                Order Details — <%= index + 1 %>
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <!-- Customer Info -->
              <div class="mb-4 p-3 bg-light rounded">
                <h6 class="fw-bold mb-2">Customer Information</h6>
                <div class="row">
                  <div class="col-md-6">
                    <strong>Name:</strong> <%= order.userId?.firstName && order.userId?.lastName ? `${order.userId.firstName} ${order.userId.lastName}` : order.fullName %>
                  </div>
                  <div class="col-md-6">
                    <strong>Email:</strong> <%= order.userId?.email || 'N/A' %>
                  </div>
                </div>
              </div>

              <!-- Ordered Items -->
              <h6 class="mb-3 fw-bold">Ordered Items</h6>
              <div class="list-group mb-4">
                <% order.items.forEach(item => { %>
                  <div class="list-group-item">
                    <div class="d-flex align-items-center justify-content-between">
                      <div class="d-flex align-items-center gap-3">
                        <img src="/uploads/<%= item.productId?.image || 'default.png' %>" 
                             alt="<%= item.name %>" 
                             width="50" 
                             height="50" 
                             class="rounded">
                        <div>
                          <strong class="d-block"><%= item.name %></strong>
                          <small class="text-muted">Quantity: <%= item.quantity %></small>
                        </div>
                      </div>
                      <div class="text-end">
                        <div class="fw-semibold">₱<%= item.price.toFixed(2) %></div>
                        <small class="text-muted">Subtotal: ₱<%= item.subtotal.toFixed(2) %></small>
                      </div>
                    </div>
                  </div>
                <% }) %>
              </div>

              <!-- Discounts -->
              <% if (order.discounts && order.discounts.length > 0) { %>
                <div class="mb-4">
                  <h6 class="fw-bold mb-3">Discounts Applied</h6>
                  <div class="list-group">
                    <% order.discounts.forEach(discount => { %>
                      <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                          <i class="bi bi-tag me-2"></i>
                          <%= discount.type === 'voucher' ? 'Voucher Discount' : 'PWD Discount' %>
                        </span>
                        <span class="text-danger">-₱<%= discount.amount.toFixed(2) %></span>
                      </div>
                    <% }) %>
                  </div>
                </div>
              <% } %>

              <!-- Total -->
              <div class="border-top pt-3">
                <div class="d-flex justify-content-between align-items-center">
                  <strong class="fs-5">Net Total:</strong>
                  <strong class="fs-5 text-success">₱<%= order.netTotal.toFixed(2) %></strong>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    <% }) %>
  </tbody>
</table>

          <div class="d-flex justify-content-center">
  <nav>
    <ul class="pagination" id="orderPagination"></ul>
  </nav>
</div>

      </div>
      
    <% } %>
    <nav>

</nav>
  </div>
  
</div>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".dropdown-toggle").forEach(toggle => {
      toggle.addEventListener("click", function (e) {
        e.preventDefault();

        const parentDropdown = this.closest(".dropdown");

        // Close others
        document.querySelectorAll(".dropdown").forEach(d => {
          if (d !== parentDropdown) d.classList.remove("show");
        });

        parentDropdown.classList.toggle("show");
      });
    });

    document.addEventListener("click", function (e) {
      if (!e.target.closest(".dropdown")) {
        document.querySelectorAll(".dropdown").forEach(d => d.classList.remove("show"));
      }
    });
  });
   const searchInput = document.getElementById("orderSearch");
  const statusFilter = document.getElementById("orderStatusFilter");
  const orderRows = Array.from(document.querySelectorAll("tbody tr"));
  const pagination = document.getElementById("orderPagination");
  const rowsPerPage = 10;
  let currentPage = 1;

  function filterOrders() {
    const query = searchInput.value.toLowerCase();
    const status = statusFilter.value;

    return orderRows.filter(row => {
      const name = row.dataset.name?.toLowerCase() || '';
      const email = row.dataset.email?.toLowerCase() || '';
      const id = row.dataset.id?.toLowerCase() || '';
      const rowStatus = row.dataset.status;

      return (
        (name.includes(query) || email.includes(query) || id.includes(query)) &&
        (status === "" || rowStatus === status)
      );
    });
  }

  function renderTable() {
    const filtered = filterOrders();
    const totalPages = Math.ceil(filtered.length / rowsPerPage);
    currentPage = Math.min(currentPage, totalPages || 1);

    orderRows.forEach(row => row.style.display = "none");

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    filtered.slice(start, end).forEach(row => {
      row.style.display = "";
    });

    renderPagination(totalPages);
  }

  function renderPagination(totalPages) {
  pagination.innerHTML = "";

  const createPageItem = (page, label = page, active = false, disabled = false) => {
    const li = document.createElement("li");
    li.className = `page-item ${active ? "active" : ""} ${disabled ? "disabled" : ""}`;
    li.innerHTML = `<a class="page-link" href="#">${label}</a>`;
    if (!disabled) {
      li.onclick = e => {
        e.preventDefault();
        currentPage = page;
        renderTable();
      };
    }
    return li;
  };

  if (totalPages > 1) {
    if (currentPage > 1) pagination.appendChild(createPageItem(currentPage - 1, "«"));

    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
        pagination.appendChild(createPageItem(i, i, i === currentPage));
      } else if (
        (i === 2 && currentPage > 3) ||
        (i === totalPages - 1 && currentPage < totalPages - 2)
      ) {
        pagination.appendChild(createPageItem(null, "...", false, true));
      }
    }

    if (currentPage < totalPages) pagination.appendChild(createPageItem(currentPage + 1, "»"));
  }
}


  searchInput.addEventListener("input", () => {
    currentPage = 1;
    renderTable();
  });

  statusFilter.addEventListener("change", () => {
    currentPage = 1;
    renderTable();
  });

  // Initial render
  renderTable();



  function filterOrders() {
  const query = searchInput.value.toLowerCase();
  const status = statusFilter.value;
  const fromDate = document.getElementById("dateFrom").value;
  const toDate = document.getElementById("dateTo").value;

  return orderRows.filter(row => {
    const name = row.dataset.name?.toLowerCase() || '';
    const email = row.dataset.email?.toLowerCase() || '';
    const id = row.dataset.id?.toLowerCase() || '';
    const rowStatus = row.dataset.status;

    // Get date from table (5th column: Date)
    const dateText = row.cells[4].innerText; 
    const rowDate = new Date(dateText);

    // Date filter
    let isWithinRange = true;
    if (fromDate) {
      const from = new Date(fromDate);
      isWithinRange = isWithinRange && rowDate >= from;
    }
    if (toDate) {
      const to = new Date(toDate);
      // include entire day (set 23:59:59)
      to.setHours(23, 59, 59, 999);
      isWithinRange = isWithinRange && rowDate <= to;
    }

    return (
      (name.includes(query) || email.includes(query) || id.includes(query)) &&
      (status === "" || rowStatus === status) &&
      isWithinRange
    );
  });
}
document.getElementById("dateFrom").addEventListener("change", () => {
  currentPage = 1;
  renderTable();
});

document.getElementById("dateTo").addEventListener("change", () => {
  currentPage = 1;
  renderTable();
});
document.getElementById("clearFilters").addEventListener("click", () => {
  document.getElementById("orderSearch").value = "";
  document.getElementById("dateFrom").value = "";
  document.getElementById("dateTo").value = "";
  document.getElementById("orderStatusFilter").value = "";
  currentPage = 1;
  renderTable(); // re-render your table with cleared filters
});
</script>

</body>
</html>
