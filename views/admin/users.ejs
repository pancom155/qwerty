<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Users</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/AdminDashboard.css">
</head>
<body>

  <div class="sidebar" id="sidebar">
    <div class="d-flex justify-content-center mb-5 mt-3">
     <img src="<%= settings.logo ? settings.logo : '/images/napslogo.png' %>" alt="Logo" width="150" />
    </div>
    <nav>
      <a href="/admin/index"><i class="bi bi-speedometer2"></i> Dashboard</a>
      <a href="/admin/users" class="active"><i class="bi bi-person-circle"></i> Users Profile</a>
      <a href="/admin/staff"><i class="bi bi-people-fill"></i> Account Creation</a>
      <a href="/admin/orders"><i class="bi bi-receipt"></i> Orders</a>
      <a href="/admin/reservations"><i class="bi bi-journal-bookmark"></i> Reservations</a>
      <a href="/admin/discounts"><i class="bi bi-percent"></i> Discounts</a>
      <a href="/admin/reviews"><i class="bi bi-chat-dots"></i> Users Reviews</a>
      <a href="/admin/products"><i class="bi bi-box-seam"></i> Inventory</a>
      <a href="/admin/table"><i class="bi bi-table"></i> Table</a>
        <a href="/admin/calendar"><i class="bi bi-calendar-event"></i> Calendar</a>
<a href="/admin/settings" ><i class="bi bi-gear"></i> Settings</a>
    </nav>
  </div>

  <div class="main-content">
    <div class="navbar-custom-wrapper">
      <nav class="navbar navbar-custom d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <img src="/images/admin-avatar.avif" alt="Admin" class="rounded-circle me-3">
          <div class="admin-info">
            <div class="fw-semibold">Super Admin</div>
            <p>napsgrillrestobar08@gmail.com</p>
          </div>
        </div>

        <a href="/logout" class="btn btn-sm btn-danger d-flex align-items-center">
          <i class="bi bi-box-arrow-right"></i>
        </a>
      </nav>
    </div>
       <div class="container-fluid">
  <h1 class="mb-4 fw-bold ms-2" style="color: #333446;">Users List</h1>

  <!-- Search and Filter -->
  <div class="row g-2 mb-3">
    <div class="col-md-4">
      <input type="text" id="searchInput" class="form-control" placeholder="Search by name or email">
    </div>
    <div class="col-md-3">
      <select id="statusFilter" class="form-select">
        <option value="">All Status</option>
        <option value="Active">Active</option>
        <option value="Blocked">Blocked</option>
      </select>
    </div>
  </div>

  <% if (users.length === 0) { %>
    <p>No users found.</p>
  <% } else { %>
    <table class="table table-bordered table-hover" id="usersTable">
      <thead class="bg-primary text-white">
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Email</th>
          <th>Contact</th>
          <th>Address</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="usersBody">
        <% users.forEach((user, index) => { %>
        <tr data-name="<%= user.firstName + ' ' + user.lastName %>" data-email="<%= user.email %>" data-status="<%= user.isVerified ? 'Active' : 'Blocked' %>">
          <td class="user-index"><%= index + 1 %></td>
          <td><%= user.firstName %> <%= user.lastName %></td>
          <td><%= user.email %></td>
          <td><%= user.contactNo %></td>
          <td><%= user.address %></td>
          <td>
            <% if (user.isVerified) { %>
              <span class="badge bg-success">Active</span>
            <% } else { %>
              <span class="badge bg-danger">Blocked</span>
            <% } %>
          </td>
          <td>
            <% if (user.isVerified) { %>
              <button class="btn btn-sm btn-warning" onclick="handleUserStatus('<%= user._id %>', 'block')">
                <i class="bi bi-lock-fill"></i> Block
              </button>
            <% } else { %>
              <button class="btn btn-sm btn-success" onclick="handleUserStatus('<%= user._id %>', 'unblock')">
                <i class="bi bi-unlock-fill"></i> Unblock
              </button>
            <% } %>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>

<nav aria-label="User pagination" class="mt-4">
  <ul class="pagination justify-content-center mb-0" id="pagination"></ul>
</nav>


  <% } %>
</div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const searchInput = document.getElementById("searchInput");
  const statusFilter = document.getElementById("statusFilter");
  const tableRows = Array.from(document.querySelectorAll("#usersBody tr"));
  const pagination = document.getElementById("pagination");

  const rowsPerPage = 10;
  let currentPage = 1;

  function renderTable() {
    const search = searchInput.value.toLowerCase();
    const status = statusFilter.value;

    const filteredRows = tableRows.filter(row => {
      const name = row.dataset.name.toLowerCase();
      const email = row.dataset.email.toLowerCase();
      const rowStatus = row.dataset.status;

      return (
        (name.includes(search) || email.includes(search)) &&
        (status === "" || rowStatus === status)
      );
    });

    const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
    currentPage = Math.min(currentPage, totalPages || 1);

    tableRows.forEach(row => (row.style.display = "none"));

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    filteredRows.slice(start, end).forEach((row, i) => {
      row.style.display = "";
      const indexCell = row.querySelector(".user-index");
      if (indexCell) indexCell.textContent = start + i + 1;
    });

    renderPagination(totalPages);
  }

  function renderPagination(totalPages) {
    pagination.innerHTML = "";

    for (let i = 1; i <= totalPages; i++) {
      const li = document.createElement("li");
      li.className = `page-item ${i === currentPage ? "active" : ""}`;
      li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
      li.addEventListener("click", e => {
        e.preventDefault();
        currentPage = i;
        renderTable();
      });
      pagination.appendChild(li);
    }
  }

  function handleUserStatus(userId, action) {
    const actionText = action === 'block' ? 'Block' : 'Unblock';
    const buttonColor = action === 'block' ? '#d33' : '#28a745';

    Swal.fire({
      title: `Are you sure?`,
      text: `You are about to ${actionText.toLowerCase()} this user.`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: buttonColor,
      cancelButtonColor: '#6c757d',
      confirmButtonText: `Yes, ${actionText}`
    }).then(result => {
      if (result.isConfirmed) {
        fetch(`/admin/users/${userId}/${action}`, {
          method: 'POST'
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: `${actionText}ed!`,
              text: data.message,
              timer: 1500,
              showConfirmButton: false
            }).then(() => location.reload());
          } else {
            Swal.fire('Error', data.message, 'error');
          }
        })
        .catch(() => {
          Swal.fire('Error', 'Something went wrong.', 'error');
        });
      }
    });
  }

  // Event listeners
  searchInput.addEventListener("input", () => {
    currentPage = 1;
    renderTable();
  });

  statusFilter.addEventListener("change", () => {
    currentPage = 1;
    renderTable();
  });

  // Initial load
  renderTable();
</script>

</body>
</html>
